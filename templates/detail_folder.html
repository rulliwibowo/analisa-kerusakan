{% extends "base.html" %} {% block title %}Detail Folder{% endblock %} {% block
content %}

<div class="container mt-4 col-lg-11">
  <h2>üìÅ Folder: {{ folder.nama_folder }}</h2>
  <p><strong>Description:</strong> {{ folder.informasi }}</p>

  <div class="d-flex justify-content-end mb-3">
    <button
      class="btn btn-primary"
      data-toggle="modal"
      data-target="#uploadModal"
    >
      <i class="bi bi-upload me-2"></i> Upload & Analysis
    </button>
  </div>

  <!-- MODAL UPLOAD -->
  <div
    class="modal fade"
    id="uploadModal"
    tabindex="-1"
    role="dialog"
    aria-labelledby="uploadModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <form
          action="{{ url_for('upload_analisa', folder_id=folder.id) }}"
          method="POST"
          enctype="multipart/form-data"
        >
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="uploadModalLabel">Upload & Analysis</h5>
            <button type="button" class="close text-white" data-dismiss="modal">
              <span>&times;</span>
            </button>
          </div>

          <div class="modal-body">
            <div class="form-group">
              <label for="image">Select Photo (JPG/PNG):</label>
              <input
                type="file"
                class="form-control"
                id="image"
                name="image[]"
                accept="image/*"
                multiple
                required
                style="height: auto !important"
              />
              <small class="text-muted"
                >* The photo will be analyzed immediately by the system.
              </small>
            </div>
          </div>

          <div class="modal-footer">
            <button type="submit" class="btn btn-success">
              <i class="bi bi-search"></i> Analyze Now
            </button>
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="card mt-4 shadow-sm">
    <div class="card-body">
      <h5 class="card-title mb-3">üì∑ Photo and Analysis Results</h5>

      <form id="bulkDeleteForm">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <span class="text-muted">Check the photos you want to delete.</span>
          <button type="submit" class="btn btn-sm btn-danger">
            üóëÔ∏è Delete Selected
          </button>
        </div>

        <div class="table-responsive">
          <table class="table table-bordered align-middle">
            <thead class="bg-primary text-white">
              <tr>
                <th class="text-center">
                  <input type="checkbox" id="selectAll" />
                </th>
                <th class="text-center">Photo</th>
                <th class="text-center">Type of Damage</th>
                <th class="text-center">Area %</th>
                <th class="text-center">DV</th>
                <th class="text-center">PCI</th>
                <th class="text-center" style="width: 200px">Action</th>
              </tr>
            </thead>
            <tbody>
              {% for h in hasil_list %}
              <tr>
                <td class="align-top text-center">
                  <div class="form-check m-0">
                    <input
                      type="checkbox"
                      class="form-check-input select-item"
                      name="selected_ids"
                      value="{{ h.id }}"
                    />
                  </div>
                </td>
                <td class="text-center">
                  <img
                    src="{{ url_for('static', filename='uploads_analisa/' ~ folder.nama_folder ~ '/' ~ h.filename) }}"
                    class="img-thumbnail img-detail"
                    style="max-width: 100px; cursor: pointer"
                    data-toggle="modal"
                    data-target="#modalDetail"
                    data-area="{{ h.luas_total | default('0') }}"
                    data-filename="{{ h.filename }}"
                    data-id="{{ h.id }}"
                    data-detail="{{ h.detail_kerusakan | default('Tidak ada detail') }}"
                    data-pci="{{ h.nilai_pci | default('N/A') }}"
                    data-dv="{{ h.total_deduct | default('N/A') }}"
                    alt="Gambar"
                  />
                </td>
                <td>
                  {% set jenis_list = [] %} {% for b in h.boxes_json %} {% if
                  b.jenis not in jenis_list %} {% set _ =
                  jenis_list.append(b.jenis) %} {% endif %} {% endfor %} {% if
                  jenis_list %}
                  <ul class="mb-0" style="padding-left: 20px">
                    {% for jenis in jenis_list %}
                    <li>{{ jenis }}</li>
                    {% endfor %}
                  </ul>
                  {% else %}
                  <span class="text-muted">Tidak ada kerusakan</span>
                  {% endif %}
                </td>
                <td class="text-center">
                  {{ h.luas_total | default(0) | int }}
                </td>
                <td class="text-center">
                  {{ h.total_deduct | default(0) | int }}
                </td>
                <td style="text-align: center">
                  {{ h.nilai_pci | int if h.nilai_pci is not none else 'N/A' }}
                </td>

                <td class="text-center">
                  <div class="d-flex justify-content-center">
                    <button
                      type="button"
                      class="btn btn-sm btn-outline-primary btn-detail"
                      style="width: 100px"
                      data-toggle="modal"
                      data-target="#modalDetail"
                      data-area="{{ h.luas_total | default('0') }}"
                      data-filename="{{ h.filename }}"
                      data-id="{{ h.id }}"
                      data-detail="{{ h.detail_kerusakan | default('Tidak ada detail') }}"
                      data-pci="{{ h.nilai_pci | default('N/A') }}"
                      data-dv="{{ h.total_deduct | default('N/A') }}"
                    >
                      üîç Detail
                    </button>

                    <button
                      type="button"
                      class="btn btn-sm btn-outline-danger btn-delete ml-2"
                      style="width: 100px"
                      data-id="{{ h.id }}"
                      data-toggle="modal"
                      data-target="#deleteModal"
                    >
                      üóëÔ∏è Delete
                    </button>
                  </div>
                </td>
              </tr>
              <script type="application/json" id="boxes-{{ h.id }}">
                {{ h.boxes_json | tojson | safe }}
              </script>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </form>
    </div>
  </div>

  <a href="{{ url_for('index') }}" class="btn btn-secondary mt-4">‚¨ÖÔ∏è Back</a>
</div>

<!-- MODAL DELETE -->
<div
  class="modal fade"
  id="deleteModal"
  tabindex="-1"
  role="dialog"
  aria-labelledby="deleteModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Konfirmasi Penghapusan</h5>
        <button type="button" class="close" data-dismiss="modal">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body">Apakah Anda yakin ingin menghapus foto ini?</div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">
          Batal
        </button>
        <button type="button" class="btn btn-danger" id="confirmDelete">
          Hapus
        </button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL DETAIL GAMBAR -->
<div class="modal fade" id="modalDetail" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Detail Analisa</h5>
        <button type="button" class="close" data-dismiss="modal">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body text-center">
        <div style="position: relative; display: inline-block">
          <img id="detail-img" src="" style="max-width: 100%" />
          <canvas
            id="detail-canvas"
            class="position-absolute"
            style="top: 0; left: 0; z-index: 10"
          ></canvas>
          <div id="detail-info" class="mt-3 text-start">
            <div class="card mt-3 shadow-sm">
              <div class="card-header bg-primary text-white">
                <i class="bi bi-bar-chart-line"></i> Detection Result
              </div>
              <div class="card-body">
                <div class="row text-center">
                  <div class="col-md-4 mb-3">
                    <h6>Luas Kerusakan</h6>
                    <p class="h5 text-danger mb-0">
                      <span id="info-area">-</span>
                    </p>
                  </div>
                  <div class="col-md-4 mb-3">
                    <h6>Deduct Value</h6>
                    <p class="h5 text-warning mb-0">
                      <span id="info-dv">-</span>
                    </p>
                  </div>
                  <div class="col-md-4 mb-3">
                    <h6>PCI</h6>
                    <p class="h5 text-success mb-0">
                      <span id="info-pci">-</span>
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  #detail-canvas {
    position: absolute;
    top: 0;
    left: 0;
    pointer-events: none;
  }
</style>

<script>
  let selectedId = null;

  document.querySelectorAll(".btn-delete").forEach((btn) => {
    btn.addEventListener("click", function () {
      selectedId = this.getAttribute("data-id");
    });
  });

  document
    .getElementById("confirmDelete")
    .addEventListener("click", function () {
      if (!selectedId) return;
      fetch("/delete_hasil/" + selectedId, { method: "POST" })
        .then((res) => res.json())
        .then((data) => {
          if (data.success) {
            $("#deleteModal").modal("hide");
            location.reload();
          }
        });
    });

  document.querySelectorAll(".img-detail, .btn-detail").forEach((btn) => {
    btn.addEventListener("click", () => {
      const filename = btn.getAttribute("data-filename");
      const id = btn.getAttribute("data-id");
      const imageUrl =
        `/static/uploads_analisa/{{ folder.nama_folder }}/` + filename;

      const img = document.getElementById("detail-img");
      const canvas = document.getElementById("detail-canvas");
      const ctx = canvas.getContext("2d");

      img.src = imageUrl;

      // Tambahkan ini:
      const dv = parseFloat(btn.getAttribute("data-dv"));
      document.getElementById("info-dv").textContent = isNaN(dv)
        ? "-"
        : Math.round(dv);

      document.getElementById("info-pci").textContent = Math.round(
        parseFloat(btn.getAttribute("data-pci"))
      );

      const boxScript = document.getElementById("boxes-" + id);
      if (!boxScript) return;
      const boxes = JSON.parse(boxScript.textContent);

      img.onload = () => {
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Set luas dari backend
        document.getElementById("info-area").textContent =
          parseFloat(btn.getAttribute("data-area")).toFixed(0) + " %";

        // Gambar bounding box
        boxes.forEach((b) => {
          ctx.beginPath();

          let strokeColor = "red";
          let fillColor = "rgba(255,0,0,0.7)";
          switch (b.jenis) {
            case "Retak Buaya":
              strokeColor = "red";
              fillColor = "rgba(255, 0, 0, 0.7)";
              break;
            case "Lubang":
              strokeColor = "yellow";
              fillColor = "rgba(255, 255, 0, 0.6)";
              break;
            case "Retak Memanjang":
              strokeColor = "blue";
              fillColor = "rgba(0, 0, 255, 0.5)";
              break;
            case "Retak Melintang":
              strokeColor = "green";
              fillColor = "rgba(0, 255, 0, 0.4)";
              break;
            default:
              strokeColor = "gray";
              fillColor = "rgba(128, 128, 128, 0.5)";
          }

          ctx.strokeStyle = strokeColor;
          ctx.lineWidth = 2;
          ctx.rect(b.x1, b.y1, b.x2 - b.x1, b.y2 - b.y1);
          ctx.stroke();

          ctx.fillStyle = fillColor;
          ctx.font = "14px sans-serif";
          ctx.fillText(
            `${b.jenis} (${b.tingkat_kerusakan}) - ${b.luas_persen?.toFixed(
              2
            )}% | DV: ${b.deduct_value}`,
            b.x1 + 4,
            b.y1 + 16
          );
        });

        // Isi tabel kerusakan
        const tbody = document.querySelector("#table-detail-kerusakan tbody");
        tbody.innerHTML = "";

        let totalDV = 0;
        boxes.forEach((b) => {
          const row = document.createElement("tr");
          row.innerHTML = `
      <td>${b.jenis}</td>
      <td>${b.tingkat_kerusakan}</td>
      <td>${(b.luas_persen ?? 0).toFixed(0)}%</td>
      <td>${(b.deduct_value ?? 0).toFixed(0)}</td>
    `;
          tbody.appendChild(row);
          totalDV += b.deduct_value ?? 0;
        });
      };
    });
  });
</script>
<script>
  // Select all
  document.getElementById("selectAll").addEventListener("change", function () {
    const checked = this.checked;
    document.querySelectorAll(".select-item").forEach((cb) => {
      cb.checked = checked;
    });
  });

  // Handle bulk delete
  document
    .getElementById("bulkDeleteForm")
    .addEventListener("submit", function (e) {
      e.preventDefault();

      const selected = Array.from(
        document.querySelectorAll(".select-item:checked")
      ).map((cb) => cb.value);

      if (selected.length === 0) {
        alert("Tidak ada gambar yang dipilih.");
        return;
      }

      if (
        !confirm(
          "Yakin ingin menghapus " + selected.length + " gambar terpilih?"
        )
      )
        return;

      fetch("/delete_bulk", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ ids: selected }),
      })
        .then((res) => res.json())
        .then((data) => {
          if (data.success) {
            location.reload();
          } else {
            alert("Gagal menghapus data.");
          }
        });
    });
</script>

{% endblock %}

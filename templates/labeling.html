{% extends "base.html" %} {% block title %}Photo Labeling{% endblock %} {% block
page_title %}Photo Labeling{% endblock %} {% block content %}

<!-- Statistics Cards -->
<div class="row g-4 mb-4">
  <div class="col-sm-6 col-xl-3">
    <div class="card">
      <div class="card-body">
        <div class="d-flex align-items-start justify-content-between">
          <div class="content-left">
            <span>Total Sample</span>
            <div class="d-flex align-items-end mt-2">
              <h4 class="mb-0 me-2">{{ total_sample }}</h4>
            </div>
            <p class="mb-0">All uploaded images</p>
          </div>
          <div class="avatar">
            <span class="avatar-initial rounded bg-label-primary">
              <i class="bi bi-images fs-4"></i>
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% for jenis, count in jenis_counter.items() %}
  <div class="col-sm-6 col-xl-3">
    <div class="card">
      <div class="card-body">
        <div class="d-flex align-items-start justify-content-between">
          <div class="content-left">
            <span>{{ jenis }}</span>
            <div class="d-flex align-items-end mt-2">
              <h4 class="mb-0 me-2">{{ count }}</h4>
            </div>
            <p class="mb-0">Labeled samples</p>
          </div>
          <div class="avatar">
            <span
              class="avatar-initial rounded {% if jenis == 'Lubang' %} bg-label-danger {% elif jenis == 'Retak Buaya' %} bg-label-warning {% elif jenis == 'Retak Memanjang' %} bg-label-info {% elif jenis == 'Retak Melintang' %} bg-label-primary {% else %} bg-label-dark {% endif %}"
            >
              <i class="bi bi-pci-card-patch-fill fs-4"></i>
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endfor %}
</div>

<!-- Photo List Card -->
{% if images %}
<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0">ðŸ“· List of Photos</h5>
    <button
      class="btn btn-primary"
      data-bs-toggle="modal"
      data-bs-target="#uploadModal"
    >
      <i class="bi bi-upload me-1"></i> Upload Photo
    </button>
  </div>
  <div class="table-responsive text-nowrap">
    <table class="table table-hover align-middle">
      <thead>
        <tr>
          <th>Photo</th>
          <th>Type of Road Damage</th>
          <th class="text-center">Action</th>
        </tr>
      </thead>
      <tbody class="table-border-bottom-0">
        {% for img in images %}
        <tr>
          <td>
            <img
              src="{{ url_for('static', filename='uploads/' ~ img.filename) }}"
              class="img-thumbnail"
              style="width: 100px; height: 75px; object-fit: cover"
            />
          </td>
          <td id="label-cell-{{ img.id }}" style="white-space: normal">
            {{ img.jenis_kerusakan or "Not Labeled" }}
          </td>
          <td class="text-center">
            <button
              class="btn btn-sm btn-info open-labeling"
              data-bs-toggle="modal"
              data-bs-target="#modalLabeling"
              data-id="{{ img.id }}"
              data-filename="{{ img.filename }}"
              data-box-id="boxes-{{ img.id }}"
            >
              <i class="bi bi-pencil-square me-1"></i> Label
            </button>
            <form
              method="POST"
              action="{{ url_for('delete_sample', filename=img.filename) }}"
              class="d-inline-block"
              onsubmit="return confirm('Are you sure you want to delete this image?');"
            >
              <button type="submit" class="btn btn-sm btn-danger">
                <i class="bi bi-trash me-1"></i> Delete
              </button>
            </form>
          </td>
        </tr>
        <script type="application/json" id="boxes-{{ img.id }}">
          {{ img.boxes | tojson | safe }}
        </script>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% else %}
<div class="alert alert-info">
  No images available. Click 'Upload Photo' to get started.
</div>
{% endif %}

<!-- Upload Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <form
        action="{{ url_for('upload_sample') }}"
        method="POST"
        enctype="multipart/form-data"
      >
        <div class="modal-header">
          <h5 class="modal-title" id="uploadModalLabel">Upload Photo</h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="image" class="form-label"
              >Select Photo (JPG/PNG):</label
            >
            <input
              type="file"
              class="form-control"
              id="image"
              name="image"
              accept="image/*"
              required
            />
            <div class="form-text">
              * The image will be used for manual labeling.
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-outline-secondary"
            data-bs-dismiss="modal"
          >
            Cancel
          </button>
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-upload me-1"></i> Upload
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Labeling Modal -->
<div class="modal fade" id="modalLabeling" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Photo Labeling</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <!-- Canvas Area -->
          <div class="col-md-8">
            <div
              style="
                position: relative;
                display: inline-block;
                cursor: crosshair;
              "
            >
              <img
                id="modal-img"
                src=""
                style="max-width: 100%; user-select: none"
                draggable="false"
              />
              <canvas
                id="modal-canvas"
                class="position-absolute"
                style="top: 0; left: 0"
              ></canvas>
            </div>
          </div>
          <!-- Box List Area -->
          <div class="col-md-4">
            <h6><i class="bi bi-list-task"></i> Bounding Box List</h6>
            <hr />
            <div
              id="box-items"
              style="max-height: 400px; overflow-y: auto"
            ></div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-outline-secondary"
          data-bs-dismiss="modal"
        >
          Cancel
        </button>
        <button type="button" id="save-labels-btn" class="btn btn-primary">
          <i class="bi bi-save me-1"></i> Save Labels
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  let currentId = null;
  let currentFilename = "";
  let boxes = [];
  let previewBox = null;

  function updateBoxList() {
    const list = document.getElementById("box-items");
    list.innerHTML = "";
    boxes.forEach((b, i) => {
      const div = document.createElement("div");
      div.className = "d-flex align-items-center mb-2";
      div.innerHTML = `
        <span class="badge bg-label-secondary me-2">#${i + 1}</span>
        <select class="form-select form-select-sm me-2" data-index="${i}" name="jenis">
          <option ${b.jenis === "Lubang" ? "selected" : ""}>Lubang</option>
          <option ${
            b.jenis === "Retak Buaya" ? "selected" : ""
          }>Retak Buaya</option>
          <option ${
            b.jenis === "Retak Memanjang" ? "selected" : ""
          }>Retak Memanjang</option>
          <option ${
            b.jenis === "Retak Melintang" ? "selected" : ""
          }>Retak Melintang</option>
        </select>
        <button class="btn btn-sm btn-icon btn-outline-danger remove-box" data-index="${i}"><i class="bi bi-x-lg"></i></button>
      `;
      list.appendChild(div);
    });

    document.querySelectorAll(".remove-box").forEach((btn) => {
      btn.onclick = () => {
        const idx = parseInt(btn.getAttribute("data-index"));
        boxes.splice(idx, 1);
        updateBoxList();
        drawAll(
          document.getElementById("modal-canvas").getContext("2d"),
          document.getElementById("modal-canvas")
        );
      };
    });

    document.querySelectorAll("#box-items select").forEach((select) => {
      select.onchange = () => {
        const i = parseInt(select.getAttribute("data-index"));
        if (select.name === "jenis") boxes[i].jenis = select.value;
      };
    });
  }

  function drawAll(ctx, canvas) {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    boxes.forEach((b, i) => {
      ctx.beginPath();
      ctx.strokeStyle = "#ff3e1d"; // Vuexy danger color
      ctx.lineWidth = 2;
      ctx.rect(b.x1, b.y1, b.x2 - b.x1, b.y2 - b.y1);
      ctx.stroke();
      ctx.fillStyle = "rgba(255, 62, 29, 0.8)";
      ctx.font = "bold 14px 'Public Sans'";
      ctx.fillText(`#${i + 1}`, b.x1 + 5, b.y1 + 18);
    });
    if (previewBox) {
      ctx.strokeStyle = "rgba(105, 108, 255, 0.9)"; // Vuexy primary color
      ctx.lineWidth = 2;
      ctx.setLineDash([5, 3]);
      ctx.strokeRect(
        previewBox.x1,
        previewBox.y1,
        previewBox.x2 - previewBox.x1,
        previewBox.y2 - previewBox.y1
      );
      ctx.setLineDash([]);
    }
  }

  document.querySelectorAll(".open-labeling").forEach((btn) => {
    btn.addEventListener("click", () => {
      currentId = btn.getAttribute("data-id");
      currentFilename = btn.getAttribute("data-filename");
      const imageUrl = `/static/uploads/${currentFilename}`;
      const img = document.getElementById("modal-img");
      img.setAttribute("src", imageUrl);
      const boxScript = document.getElementById(
        btn.getAttribute("data-box-id")
      );
      boxes = boxScript ? JSON.parse(boxScript.textContent) : [];
      boxes = boxes.map((b) => {
        return {
          x1: b[0],
          y1: b[1],
          x2: b[2],
          y2: b[3],
          jenis: b.length >= 5 ? b[4] : "Lubang",
        };
      });

      img.onload = () => {
        const canvas = document.getElementById("modal-canvas");
        // Match canvas size to the displayed image size
        canvas.width = img.clientWidth;
        canvas.height = img.clientHeight;
        // Store scale factors
        canvas.dataset.scaleX = img.clientWidth / img.naturalWidth;
        canvas.dataset.scaleY = img.clientHeight / img.naturalHeight;
        drawAll(canvas.getContext("2d"), canvas);
        updateBoxList();
      };
    });
  });

  (() => {
    let drawing = false,
      startX = 0,
      startY = 0;
    const canvas = document.getElementById("modal-canvas");
    const ctx = canvas.getContext("2d");

    const getMousePos = (e) => {
      const rect = canvas.getBoundingClientRect();
      const scaleX = canvas.width / rect.width;
      const scaleY = canvas.height / rect.height;
      return {
        x: (e.clientX - rect.left) * scaleX,
        y: (e.clientY - rect.top) * scaleY,
      };
    };

    canvas.addEventListener("mousedown", (e) => {
      ({ x: startX, y: startY } = getMousePos(e));
      drawing = true;
      previewBox = null;
    });
    canvas.addEventListener("mousemove", (e) => {
      if (!drawing) return;
      const { x, y } = getMousePos(e);
      previewBox = {
        x1: Math.min(startX, x),
        y1: Math.min(startY, y),
        x2: Math.max(startX, x),
        y2: Math.max(startY, y),
      };
      drawAll(ctx, canvas);
    });
    canvas.addEventListener("mouseup", () => {
      if (!drawing || !previewBox) return;
      drawing = false;
      boxes.push({ ...previewBox, jenis: "Lubang" });
      previewBox = null;
      drawAll(ctx, canvas);
      updateBoxList();
    });
  })();

  document.getElementById("save-labels-btn").addEventListener("click", () => {
    const canvas = document.getElementById("modal-canvas");
    const scaleX = parseFloat(canvas.dataset.scaleX) || 1;
    const scaleY = parseFloat(canvas.dataset.scaleY) || 1;

    // Convert coordinates back to original image dimensions before saving
    const payload = boxes.map((b) => [
      Math.round(b.x1 / scaleX),
      Math.round(b.y1 / scaleY),
      Math.round(b.x2 / scaleX),
      Math.round(b.y2 / scaleY),
      b.jenis,
    ]);

    fetch(`/save_label/${currentId}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ boxes: payload }),
    })
      .then((res) => res.json())
      .then((data) => {
        if (data.status === "success") {
          // Reload the page to show the updated label in the table
          location.reload();
        } else {
          alert("Failed to save label: " + (data.error || "Unknown error"));
        }
      })
      .catch(() => alert("An error occurred while saving."));
  });
</script>
{% endblock %}
